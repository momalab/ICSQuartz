#! /usr/bin/env python2
import sys
from struct import pack

sys.path.append("..")
from lib.layers import s_tag, layer7, pretty_format_tags_recursive, pretty_format_tagsdict
from lib import pycodesys

cds = None

# Send CmpCoreDump CmdID=1 Create CoreDump
def send_cmd1():
    global cds
    print('[c] CmpCoreDump CmdID=1 Create ')
    service_id = 0x1f  # CmpCoreDump
    command_id = 0x01
    data = s_tag(0x2, pack("<I", cds.app_sess_id))
    L7 = layer7(service_id, command_id, cds.sess_id, data)
    cds.send_layer7(L7)
    tags = cds.recv_layer7()
    print('** result: **\n')
    # # 0x83 frame info
    print(pretty_format_tagsdict(tags))


# Send CmpCoreDump CmdID=2 Read CoreDump
def send_cmd2():
    global cds
    print('[c] CmpCoreDump CmdID=2 Read')
    service_id = 0x1f  # CmpCoreDump
    command_id = 0x02
    data = s_tag(0x2, pack("<I", cds.app_sess_id))
    L7 = layer7(service_id, command_id, cds.sess_id, data)
    cds.send_layer7(L7)
    tags = cds.recv_layer7()
    print('** result: **\n')
    # 0x3: file date, 0x2: file name
    print(pretty_format_tagsdict(tags))

# Connect to the PLC
cds = pycodesys.CodesysNode(host=sys.argv[1], port=11740, verbose=False)
chan_id = cds.connect()
if not chan_id:
    exit(0)

# Device login
cds.loginToDevice()

# App login
cds.loginToApp()

# send_cmd1()
send_cmd2()

cds.disconnect()
